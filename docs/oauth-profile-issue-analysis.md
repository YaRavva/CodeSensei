# Анализ проблемы с профилем после OAuth

## Проблема
После авторизации через GitHub у админа:
1. Аватар показывает "U" вместо инициалов
2. Нет ссылки на админку в навбаре
3. Нет достижений на странице профиля
4. Даже переход на /admin/modules/new не решает проблему

## Возможные причины

### 1. Профиль не создается триггером
- Триггер `on_auth_user_created` должен создавать профиль автоматически
- Проверка: зайти в Supabase Dashboard и проверить, создается ли профиль в таблице `users`

### 2. Профиль создается, но с неправильной ролью
- Триггер берет роль из `raw_app_meta_data->>'user_role'` или `raw_user_meta_data->>'role'`
- Если роль не указана в metadata, устанавливается 'student' по умолчанию
- **Решение**: Установить роль 'admin' в metadata пользователя в Supabase Dashboard или через SQL

### 3. Профиль создается, но клиент не может его прочитать
- RLS политика "Users can view own profile" должна разрешать чтение
- Проверка: проверить, что `auth.uid() = id` работает корректно

### 4. Race condition между созданием пользователя и профиля
- Callback редиректит до создания профиля триггером
- Клиент пытается загрузить профиль, но его еще нет
- **Решение**: Увеличить задержки и количество retry

### 5. Профиль загружается на сервере, но не синхронизируется с клиентом
- `requireAuth()` загружает профиль на сервере
- Клиентский `AuthProvider` не знает об этом
- **Решение**: Добавить синхронизацию через API endpoint

## Диагностика

### Проверка в консоли браузера
После авторизации через GitHub проверьте логи:
- `[AuthProvider] Profile loaded successfully` - профиль загружен
- `[AuthProvider] Profile not found` - профиль не найден
- `[Navigation] Profile loaded` - профиль загружен в навигации

### Проверка в Supabase Dashboard
1. Зайти в Authentication > Users
2. Найти пользователя по email
3. Проверить metadata (app_metadata и user_metadata)
4. Проверить, есть ли запись в таблице `users` с таким же `id`

### Проверка роли
```sql
SELECT id, email, role, display_name FROM public.users WHERE email = 'admin@example.com';
```

Если роль 'student', нужно обновить:
```sql
UPDATE public.users SET role = 'admin' WHERE email = 'admin@example.com';
```

## Реализованные исправления

1. ✅ Увеличено количество retry с 3 до 8 попыток
2. ✅ Добавлена синхронизация через API endpoint `/api/auth/sync-profile`
3. ✅ Добавлено периодическое обновление профиля каждые 5 секунд
4. ✅ Улучшено логирование для диагностики
5. ✅ Добавлено принудительное обновление в AdminLayout
6. ✅ Улучшена обработка SIGNED_IN события

## Следующие шаги для диагностики

1. Проверить логи в консоли браузера после OAuth
2. Проверить, создается ли профиль в БД
3. Проверить роль пользователя в БД
4. Проверить RLS политики
5. Если профиль создается, но не загружается - проверить права доступа

